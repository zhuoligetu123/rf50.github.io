<!-- udacimak v1.4.4 -->
<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="ie=edge" http-equiv="X-UA-Compatible"/>
  <title>
   ROS Node: process_image
  </title>
  <link href="../assets/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="../assets/css/plyr.css" rel="stylesheet"/>
  <link href="../assets/css/katex.min.css" rel="stylesheet"/>
  <link href="../assets/css/jquery.mCustomScrollbar.min.css" rel="stylesheet"/>
  <link href="../assets/css/styles.css" rel="stylesheet"/>
  <link href="../assets/img/udacimak.png" rel="shortcut icon" type="image/png">
  </link>
 </head>
 <body>
  <div class="wrapper">
   <nav id="sidebar">
    <div class="sidebar-header">
     <h3>
      Project: Go Chase It!
     </h3>
    </div>
    <ul class="sidebar-list list-unstyled CTAs">
     <li>
      <a class="article" href="../index.html">
       Back to Home
      </a>
     </li>
    </ul>
    <ul class="sidebar-list list-unstyled components">
     <li class="">
      <a href="01. Introduction.html">
       01. Introduction
      </a>
     </li>
     <li class="">
      <a href="02. ROS in the Workspace.html">
       02. ROS in the Workspace
      </a>
     </li>
     <li class="">
      <a href="03. Setting up my_robot.html">
       03. Setting up my_robot
      </a>
     </li>
     <li class="">
      <a href="04. Understanding URDF.html">
       04. Understanding URDF
      </a>
     </li>
     <li class="">
      <a href="05. Robot Basic Setup.html">
       05. Robot Basic Setup
      </a>
     </li>
     <li class="">
      <a href="06. Robot Enhancements.html">
       06. Robot Enhancements
      </a>
     </li>
     <li class="">
      <a href="07. Robot Sensors.html">
       07. Robot Sensors
      </a>
     </li>
     <li class="">
      <a href="08. Gazebo Plugins.html">
       08. Gazebo Plugins
      </a>
     </li>
     <li class="">
      <a href="09. RViz Basics.html">
       09. RViz Basics
      </a>
     </li>
     <li class="">
      <a href="10. RViz Integration.html">
       10. RViz Integration
      </a>
     </li>
     <li class="">
      <a href="11. House your Robot.html">
       11. House your Robot
      </a>
     </li>
     <li class="">
      <a href="12. Setting up ball_chaser.html">
       12. Setting up ball_chaser
      </a>
     </li>
     <li class="">
      <a href="13. ROS Node drive_bot.html">
       13. ROS Node: drive_bot
      </a>
     </li>
     <li class="">
      <a href="14. Model a White Ball.html">
       14. Model a White Ball
      </a>
     </li>
     <li class="">
      <a href="15. ROS Node process_image.html">
       15. ROS Node: process_image
      </a>
     </li>
     <li class="">
      <a href="Project Description - Go Chase It!.html">
       Project Description - Go Chase It!
      </a>
     </li>
     <li class="">
      <a href="Project Rubric - Go Chase It!.html">
       Project Rubric - Go Chase It!
      </a>
     </li>
    </ul>
    <ul class="sidebar-list list-unstyled CTAs">
     <li>
      <a class="article" href="../index.html">
       Back to Home
      </a>
     </li>
    </ul>
   </nav>
   <div id="content">
    <header class="container-fluild header">
     <div class="container">
      <div class="row">
       <div class="col-12">
        <div class="align-items-middle">
         <button class="btn btn-toggle-sidebar" id="sidebarCollapse" type="button">
          <div>
          </div>
          <div>
          </div>
          <div>
          </div>
         </button>
         <h1 style="display: inline-block">
          15. ROS Node: process_image
         </h1>
        </div>
       </div>
      </div>
     </div>
    </header>
    <main class="container">
     <div class="row">
      <div class="col-12">
       <div class="ud-atom">
        <h3>
        </h3>
        <div>
         <h1 id="ros-node-process_image">
          ROS Node: process_image
         </h1>
        </div>
       </div>
       <div class="divider">
       </div>
       <div class="ud-atom">
        <h3>
        </h3>
        <div>
         <p>
          The second node that you’ll write in this project is the
          <code>
           process_image
          </code>
          node. This client node will
          <strong>
           subscribe
          </strong>
          to the robot’s camera images and analyze them to determine the position of the white ball. Once the ball position is determined, the client node will request a service from the
          <code>
           drive_bot
          </code>
          server node to drive the robot toward the ball. The robot can drive either left, right or forward, depending on the robot position inside the image.
         </p>
         <p>
          After you write this node, place the white ball in front of the robot’s camera. If everything works, your node should analyze the image, detect the ball’s position, and then request a
          <code>
           ball_chaser/command_robot
          </code>
          service to drive the robot towards the ball!
         </p>
         <h2 id="reference">
          Reference
         </h2>
         <p>
          The
          <code>
           process_image.cpp
          </code>
          client node is similar to the
          <code>
           look_away.cpp
          </code>
          client node that you wrote in this lesson. Both nodes contain a ROS
          <strong>
           subscriber
          </strong>
          and
          <strong>
           client
          </strong>
          . Please review the
          <code>
           look_away.cpp
          </code>
          node before you start coding the
          <code>
           process_image.cpp
          </code>
          node.
         </p>
         <h2 id="analyzing-the-images">
          Analyzing the Images
         </h2>
         <p>
          To identify the ball’s
          <strong>
           presence
          </strong>
          and
          <strong>
           position
          </strong>
          inside the image, you will use a simple approach. First, search for white pixels inside the array image. Since the ball is the only object in the world that is white, white pixels indicate the ball’s presence. Then, once you find that the ball, identify its position with respect to the camera - either the left, middle, or right side of the image.
         </p>
        </div>
       </div>
       <div class="divider">
       </div>
       <div class="ud-atom">
        <h3>
        </h3>
        <div>
         <figure class="figure">
          <img alt="" class="img img-fluid" src="img/analyze-image.png"/>
          <figcaption class="figure-caption">
          </figcaption>
         </figure>
        </div>
       </div>
       <div class="divider">
       </div>
       <div class="ud-atom">
        <h3>
        </h3>
        <div>
         <p>
          You’ll have to subscribe to the
          <code>
           /camera/rgb/image_raw
          </code>
          topic to get instantaneous images from the robot’s camera. Inside the callback function, retrieve the image by reading the image data message. The image message contains many fields, such as the image height, data and more. Check out the complete
          <a href="http://docs.ros.org/melodic/api/sensor_msgs/html/msg/Image.html" rel="noopener noreferrer" target="_blank">
           ROS
           <code>
            sensor_msgs/Image
           </code>
           documentation
          </a>
          .
          <br/>
          Now that you have the image messages, you have to loop through the image data. For each pixel compare it to a value of 255 indicating a bright white pixel, if this pixel is found try to identify in which section of the image it fall either left, mid, or right. Then, request a service to drive toward that direction.
         </p>
         <h2 id="write-process_imagecpp">
          Write
          <code>
           process_image.cpp
          </code>
         </h2>
         <p>
          Now it’s time to write the
          <code>
           process_image.cpp
          </code>
          client node. This node will analyze the image and request services to drive the robot. Create the source code file within the
          <code>
           src
          </code>
          directory of your
          <code>
           ball_chaser
          </code>
          package. It might be a bit challenging to write this program from scratch, thus I am providing you with some hints. Attached below is a piece of the complete code with multiple hints to help you finish the implementation.
         </p>
         <pre><code class="C++ language-C++">#include "ros/ros.h"
#include "ball_chaser/DriveToTarget.h"
#include &lt;sensor_msgs/Image.h&gt;

// Define a global client that can request services
ros::ServiceClient client;

// This function calls the command_robot service to drive the robot in the specified direction
void drive_robot(float lin_x, float ang_z)
{
    // TODO: Request a service and pass the velocities to it to drive the robot
}

// This callback function continuously executes and reads the image data
void process_image_callback(const sensor_msgs::Image img)
{

    int white_pixel = 255;

    // TODO: Loop through each pixel in the image and check if there's a bright white one
    // Then, identify if this pixel falls in the left, mid, or right side of the image
    // Depending on the white ball position, call the drive_bot function and pass velocities to it
    // Request a stop when there's no white ball seen by the camera
}

int main(int argc, char** argv)
{
    // Initialize the process_image node and create a handle to it
    ros::init(argc, argv, "process_image");
    ros::NodeHandle n;

    // Define a client service capable of requesting services from command_robot
    client = n.serviceClient&lt;ball_chaser::DriveToTarget&gt;("/ball_chaser/command_robot");

    // Subscribe to /camera/rgb/image_raw topic to read the image data inside the process_image_callback function
    ros::Subscriber sub1 = n.subscribe("/camera/rgb/image_raw", 10, process_image_callback);

    // Handle ROS communication events
    ros::spin();

    return 0;
}</code></pre>
         <p>
          Copy this code to
          <code>
           process_image.cpp
          </code>
          , and make the necessary changes.
         </p>
         <h2 id="edit-cmakeliststxt">
          Edit CMakeLists.txt
         </h2>
         <p>
          In addition to all the dependencies you added earlier for
          <code>
           drive_bot.cpp
          </code>
          , these are the dependencies that you should add for
          <code>
           process_image.cpp
          </code>
          :
         </p>
         <ul>
          <li>
           Add
           <code>
            add_executable
           </code>
          </li>
          <li>
           Add
           <code>
            target_link_libraries
           </code>
          </li>
          <li>
           Add
           <code>
            add_dependencies
           </code>
          </li>
         </ul>
         <h2 id="build-package">
          Build Package
         </h2>
         <p>
          Now that you’ve included specific instructions for your
          <code>
           process_image.cpp
          </code>
          code in
          <code>
           CMakeLists.txt
          </code>
          , compile it with:
         </p>
         <pre><code class="sh language-sh">$ cd /home/workspace/catkin_ws/
$ catkin_make</code></pre>
         <h2 id="launch-file">
          Launch File
         </h2>
         <p>
          Edit the
          <code>
           ball_chaser.launch
          </code>
          file saved under
          <code>
           /home/workspace/catkin_ws/src/ball_chaser/launch
          </code>
          and add the
          <code>
           process_image
          </code>
          node to it.
         </p>
         <p>
          Now, launching this file should run the
          <code>
           drive_bot
          </code>
          and
          <code>
           process_image
          </code>
          !
         </p>
         <h2 id="test-process_image">
          Test
          <code>
           process_image
          </code>
         </h2>
         <p>
          To test if the code you just wrote is working as expected, first launch the robot inside your world and then run both the
          <code>
           drive_bot
          </code>
          and
          <code>
           process_image
          </code>
          nodes.
         </p>
         <p>
          <strong>
           1- Launch the robot inside your world
          </strong>
         </p>
         <p>
          This can be done by launching the
          <code>
           world.launch
          </code>
          file:
         </p>
         <pre><code class="sh language-sh">$ cd /home/workspace/catkin_ws/
$ source devel/setup.bash
$ roslaunch my_robot world.launch</code></pre>
         <p>
          <strong>
           2- Run
           <code>
            drive_bot
           </code>
           and
           <code>
            process_image
           </code>
          </strong>
         </p>
         <p>
          This can be done by executing
          <code>
           ball_chaser.launch
          </code>
          :
         </p>
         <pre><code class="sh language-sh">$ cd /home/workspace/catkin_ws/
$ source devel/setup.bash
$ roslaunch ball_chaser ball_chaser.launch</code></pre>
         <h3 id="3--visualize">
          3- Visualize
         </h3>
         <p>
          To visualize the robot’s camera images, you can subscribe to camera RGB image topic from RViz. Or you can run the rqt_image_view node:
         </p>
         <pre><code class="sh language-sh">$ cd /home/workspace/catkin_ws/
$ source devel/setup.bash
$ rosrun rqt_image_view rqt_image_view  </code></pre>
         <p>
          Now place the white ball at different positions in front of the robot and see if the robot is capable of chasing the ball!
         </p>
        </div>
       </div>
       <div class="divider">
       </div>
       <div class="ud-atom">
        <h3>
        </h3>
        <div>
         <figure class="figure">
          <img alt="" class="img img-fluid" src="img/screen-shot-2018-11-26-at-4.38.15-pm-2.png"/>
          <figcaption class="figure-caption">
          </figcaption>
         </figure>
        </div>
       </div>
       <div class="divider">
       </div>
       <div class="ud-atom">
        <h3>
        </h3>
        <div>
         <div>
          <h4>
           Task Description:
          </h4>
          <p>
           Follow these steps to create the
           <code>
            process_image
           </code>
           node:
          </p>
         </div>
         <form>
          <fieldset>
           <legend>
            Task List:
           </legend>
           <div>
            <input id="15ad38ac-1513-4b43-89ad-01ba2f18f942--0" type="checkbox"/>
            <label for="15ad38ac-1513-4b43-89ad-01ba2f18f942--0">
             <p>
              ROS Node: Write the
              <code>
               process_image.cpp
              </code>
              C++ node
             </p>
            </label>
           </div>
           <div>
            <input id="15ad38ac-1513-4b43-89ad-01ba2f18f942--1" type="checkbox"/>
            <label for="15ad38ac-1513-4b43-89ad-01ba2f18f942--1">
             <p>
              CMakeLists: Edit ball_chaser’s
              <code>
               CMakeLists.txt
              </code>
              and add dependencies for
              <code>
               process_image
              </code>
             </p>
            </label>
           </div>
           <div>
            <input id="15ad38ac-1513-4b43-89ad-01ba2f18f942--2" type="checkbox"/>
            <label for="15ad38ac-1513-4b43-89ad-01ba2f18f942--2">
             <p>
              Build: Build the
              <code>
               ball_chaser
              </code>
              package to compile the
              <code>
               process_image.cpp
              </code>
              file
             </p>
            </label>
           </div>
           <div>
            <input id="15ad38ac-1513-4b43-89ad-01ba2f18f942--3" type="checkbox"/>
            <label for="15ad38ac-1513-4b43-89ad-01ba2f18f942--3">
             <p>
              Launch Files: Add the
              <code>
               process_image
              </code>
              node to the
              <code>
               ball_chaser.launch
              </code>
              file
             </p>
            </label>
           </div>
           <div>
            <input id="15ad38ac-1513-4b43-89ad-01ba2f18f942--4" type="checkbox"/>
            <label for="15ad38ac-1513-4b43-89ad-01ba2f18f942--4">
             <p>
              Testing: Launch all the nodes in this project and test your
              <code>
               process_image.cpp
              </code>
              file
             </p>
            </label>
           </div>
          </fieldset>
         </form>
         <div>
          <h4>
           Task Feedback:
          </h4>
          <p>
           Great job!
          </p>
         </div>
        </div>
       </div>
       <div class="divider">
       </div>
      </div>
      <div class="col-12">
       <p class="text-right">
       </p>
      </div>
     </div>
    </main>
    <footer class="footer">
     <div class="container">
      <div class="row">
       <div class="col-12">
        <p class="text-center">
         udacity2.0 If you need the newest courses Plase add me wechat: udacity6
        </p>
       </div>
      </div>
     </div>
    </footer>
   </div>
  </div>
  <script src="../assets/js/jquery-3.3.1.min.js">
  </script>
  <script src="../assets/js/plyr.polyfilled.min.js">
  </script>
  <script src="../assets/js/bootstrap.min.js">
  </script>
  <script src="../assets/js/jquery.mCustomScrollbar.concat.min.js">
  </script>
  <script src="../assets/js/katex.min.js">
  </script>
  <script>
   // Initialize Plyr video players
    const players = Array.from(document.querySelectorAll('video')).map(p => new Plyr(p));

    // render math equations
    let elMath = document.getElementsByClassName('mathquill');
    for (let i = 0, len = elMath.length; i < len; i += 1) {
      const el = elMath[i];

      katex.render(el.textContent, el, {
        throwOnError: false
      });
    }

    // this hack will make sure Bootstrap tabs work when using Handlebars
    if ($('#question-tabs').length && $('#user-answer-tabs').length) {
      $("#question-tabs a.nav-link").on('click', function () {
        $("#question-tab-contents .tab-pane").hide();
        $($(this).attr("href")).show();
      });
      $("#user-answer-tabs a.nav-link").on('click', function () {
        $("#user-answer-tab-contents .tab-pane").hide();
        $($(this).attr("href")).show();
      });
    } else {
      $("a.nav-link").on('click', function () {
        $(".tab-pane").hide();
        $($(this).attr("href")).show();
      });
    }

    // side bar events
    $(document).ready(function () {
      $("#sidebar").mCustomScrollbar({
        theme: "minimal"
      });

      $('#sidebarCollapse').on('click', function () {
        $('#sidebar, #content').toggleClass('active');
        $('.collapse.in').toggleClass('in');
        $('a[aria-expanded=true]').attr('aria-expanded', 'false');
      });

      // scroll to first video on page loading
      if ($('video').length) {
        $('html,body').animate({ scrollTop: $('div.plyr').prev().offset().top});
      }

      // auto play first video: this may not work with chrome/safari due to autoplay policy
      if (players && players.length > 0) {
        players[0].play();
      }

      // scroll sidebar to current concept
      const currentInSideBar = $( "ul.sidebar-list.components li a:contains('15. ROS Node: process_image')" )
      currentInSideBar.css( "text-decoration", "underline" );
      $("#sidebar").mCustomScrollbar('scrollTo', currentInSideBar);
    });
  </script>
 </body>
</html>
